name: Create Discussion for New YAML Configs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - staging
      - discussion_workflow
    paths:
      - 'cfg/**/*.yaml'

jobs:
  create-discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML

      - name: Determine default branch
        id: get_default_branch
        run: |
          echo "DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')" >> $GITHUB_ENV

      - name: Fetch default branch
        run: git fetch origin ${{ env.DEFAULT_BRANCH }}

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Process new YAML files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e
          # Compare against default branch to find new or modified YAML files
          git diff origin/${DEFAULT_BRANCH} --name-only | grep "^cfg/.*\.yaml$" | while read file; do
            # Get folder and filename
            folder=$(dirname "$file" | xargs basename)
            filename=$(basename "$file")
            discussion_title="$folder/$filename"

            echo "Processing file: $file with title: $discussion_title"

            # Construct the search query
            search_query="repo:${GITHUB_REPOSITORY} in:title \"$discussion_title\""

            # Check if discussion already exists using the search API
            existing_discussion=$(gh api graphql -f query='
              query($searchQuery:String!) {
                search(query:$searchQuery, type: DISCUSSION, first:1) {
                  nodes {
                    ... on Discussion {
                      title
                    }
                  }
                }
              }' \
              -f searchQuery="$search_query" \
              --jq '.data.search.nodes[0].title')

            if [ -z "$existing_discussion" ]; then
              # Parse YAML and extract metadata using external script
              python scripts/parse_metadata.py "$file"

              # Create discussion using GraphQL and capture the URL
              create_response=$(gh api graphql -f query='
                mutation($repositoryId: ID!, $title: String!, $body: String!) {
                  createDiscussion(input: {repositoryId: $repositoryId, title: $title, body: $body}) {
                    discussion {
                      url
                    }
                  }
                }' \
                -f repositoryId="$(gh api graphql -f query='
                  query($repo: String!) {
                    repository(name: $repo) {
                      id
                    }
                  }' -f repo="$GITHUB_REPOSITORY" --jq '.data.repository.id')" \
                -f title="$discussion_title" \
                -f body="$(cat "$file")")

              discussion_url=$(echo "$create_response" | jq -r '.data.createDiscussion.discussion.url')

              # Update YAML with discussion link using external script
              python scripts/update_yaml.py "$file" "$discussion_url"

              # Commit and push changes
              git config --global user.name "GitHub Action"
              git config --global user.email "action@github.com"
              git add "$file"
              git commit -m "Add discussion link to $discussion_title"
              git push
            else
              echo "Discussion '$discussion_title' already exists. Skipping."
            fi
          done